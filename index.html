<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã¤ã¾ã‚‰ãªã„ãŠä¸–è©±ã‚²ãƒ¼ãƒ ï¼šã­ãã†ã®ã‚ã‚‹ã„ã‚¿ã‚³</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: 'Hiragino Sans', 'Yu Gothic', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #8B5A3C 0%, #A0522D 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      color: #3d2b1f;
    }

    .container {
      width: 100%;
      max-width: 960px;
      background: #F5F5DC;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
    }

    header {
      text-align: center;
      margin-bottom: 16px;
    }

    header h1 {
      margin: 0;
      font-size: 1.5rem;
      letter-spacing: 0.08em;
    }

    header p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      opacity: 0.85;
    }

    .game-layout {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
      gap: 16px;
    }

    @media (max-width: 720px) {
      .game-layout {
        grid-template-columns: 1fr;
      }
    }

    .scene-card, .status-card {
      background: #FFFDF4;
      border-radius: 16px;
      padding: 16px;
      border: 2px solid rgba(0,0,0,0.06);
    }

    .scene-card {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .scene-title {
      font-weight: bold;
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .scene-description {
      font-size: 0.9rem;
      line-height: 1.6;
      white-space: pre-line;
    }

    .char-visual-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 4px 0 8px;
    }

    .char-visual {
      position: relative;
      width: 220px;
      height: 180px;
      border-radius: 18px;
      background: linear-gradient(to top, #f8e2b6 0%, #fff9e8 60%, #e8f5ff 100%);
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      overflow: hidden;
      touch-action: none;
    }

    .char-emoji {
      position: absolute;
      left: 50%;
      top: 54%;
      transform: translate(-50%, -50%);
      font-size: 4rem;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
    }

    .char-state-icon {
      position: absolute;
      right: 8px;
      top: 6px;
      font-size: 1.4rem;
    }

    /* å¤‰ãªé«ªã®æ¯›ã‚¿ã‚³ç”¨ã®ã€ãƒ˜ãƒ³ãƒ†ã‚³ãªé«ª */
    .hair-body {
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      width: 130px;
      height: 60px;
      border-radius: 60px 60px 40px 40px;
      background:
        radial-gradient(circle at 20% 0%, #ffdd88 0, #ffdd88 40%, transparent 60%),
        radial-gradient(circle at 50% 0%, #ffe69c 0, #ffe69c 40%, transparent 60%),
        radial-gradient(circle at 80% 0%, #ffdd88 0, #ffdd88 40%, transparent 60%);
      box-shadow: 0 2px 3px rgba(0,0,0,0.15);
      overflow: hidden;
    }

    .hair-body::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        repeating-linear-gradient(
          120deg,
          rgba(180,120,40,0.8),
          rgba(180,120,40,0.8) 2px,
          transparent 3px,
          transparent 5px
        );
      opacity: 0.4;
    }

    .hair-mark {
      position: absolute;
      top: 22px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.4rem;
      opacity: 0;
      transition: opacity 0.2s ease, transform 0.2s ease;
      pointer-events: auto;
      cursor: pointer;
    }

    .hair-mark.visible {
      opacity: 1;
      transform: translate(-50%, -4px) rotate(-10deg);
    }

    .bed-area {
      position: absolute;
      bottom: 0;
      left: 8px;
      right: 8px;
      height: 60px;
      border-radius: 16px 16px 0 0;
      background: #e2c8a0;
    }

    .blanket {
      position: absolute;
      bottom: -4px;
      left: 18px;
      right: 18px;
      height: 56px;
      border-radius: 18px 18px 0 0;
      background: linear-gradient(135deg, #ffdcc5 0%, #ffc7d4 100%);
      box-shadow: 0 -2px 4px rgba(0,0,0,0.12);
      transition: transform 0.15s ease, opacity 0.2s ease;
      touch-action: none;
      cursor: grab;
    }

    .blanket.dragging {
      cursor: grabbing;
    }

    .blanket.hidden {
      transform: translateY(70%);
      opacity: 0.1;
      pointer-events: none;
    }

    .rain-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.25s ease;
      background-image: repeating-linear-gradient(
        120deg,
        rgba(80,130,180,0.4),
        rgba(80,130,180,0.4) 1px,
        transparent 2px,
        transparent 5px
      );
    }

    .rain-overlay.visible {
      opacity: 1;
    }

    .umbrella {
      position: absolute;
      left: 18px;
      top: 20px;
      font-size: 2rem;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      cursor: pointer;
      user-select: none;
      touch-action: none;
    }

    .umbrella.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .umbrella.holding {
      transform: translateY(-3px) scale(1.05);
    }

    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.2s ease;
      white-space: nowrap;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .btn-sub {
      background: #fff7e8;
      border: 1px solid rgba(0,0,0,0.08);
      color: #5a4634;
    }

    button:not(:disabled):active {
      transform: translateY(1px);
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .message {
      font-size: 0.9rem;
      margin-top: 4px;
      min-height: 2em;
    }

    .status-card h2 {
      margin: 0 0 8px;
      font-size: 1rem;
    }

    .status-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }

    .status-label {
      opacity: 0.8;
    }

    .bar {
      flex: 1;
      height: 10px;
      border-radius: 999px;
      background: #f1e4c9;
      overflow: hidden;
      margin-left: 8px;
    }

    .bar-fill {
      height: 100%;
      width: 50%;
      border-radius: inherit;
      background: linear-gradient(90deg, #ffb347 0%, #ff6f61 100%);
      transition: width 0.25s ease;
    }

    .bar-fill.affection {
      background: linear-gradient(90deg, #8fd3f4 0%, #84fab0 100%);
    }

    .status-text {
      font-size: 0.85rem;
      margin-top: 4px;
      opacity: 0.9;
    }

    .log {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px dashed rgba(0,0,0,0.1);
      max-height: 180px;
      overflow-y: auto;
      font-size: 0.82rem;
    }

    .log-entry {
      margin-bottom: 4px;
    }

    .log-entry span.time {
      opacity: 0.6;
      margin-right: 4px;
      font-feature-settings: "tnum";
    }

    .result-area {
      margin-top: 12px;
      padding-top: 8px;
      border-top: 1px solid rgba(0,0,0,0.08);
      font-size: 0.9rem;
    }

    .result-title {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .reflection {
      margin-top: 8px;
      font-size: 0.83rem;
      background: #fff7e8;
      border-radius: 12px;
      padding: 8px;
      border: 1px dashed rgba(0,0,0,0.12);
    }

    .reflection p {
      margin: 0;
      line-height: 1.5;
    }

    .reflection ul {
      margin: 4px 0 0 18px;
      padding: 0;
    }

    .reflection li {
      margin-bottom: 2px;
    }

    .tagline {
      text-align: center;
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 10px;
    }

    .rain-progress {
      font-size: 0.8rem;
      margin-top: 2px;
      opacity: 0.85;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ã¤ã¾ã‚‰ãªã„ãŠä¸–è©±ã‚²ãƒ¼ãƒ ï¼šã­ãã†ã®ã‚ã‚‹ã„ã‚¿ã‚³</h1>
      <p>ã€Œè¦‹è¿”ã‚Šã®ãªã„å°ã•ãªã‚±ã‚¢ã€ã‚’ã€ã¤ã„ç¶šã‘ã¦ã—ã¾ã†è‡ªåˆ†ã‚’ãªãŒã‚ã¦ã¿ã‚‹ã‚²ãƒ¼ãƒ </p>
    </header>

    <div class="game-layout">
      <section class="scene-card">
        <div class="scene-title" id="sceneTitle"></div>
        <div class="scene-description" id="sceneDescription"></div>

        <div class="char-visual-wrapper">
          <div class="char-visual" id="charVisual">
            <div class="hair-body" id="hairBody"></div>
            <div class="char-emoji" id="charEmoji">ğŸ™</div>
            <div class="char-state-icon" id="charStateIcon">ğŸ’¤</div>
            <div class="bed-area"></div>
            <div class="blanket" id="blanket"></div>
            <div class="rain-overlay" id="rainOverlay"></div>
            <div class="umbrella" id="umbrella">ğŸŒ‚</div>
            <div class="hair-mark" id="hairMark">ğŸ’¤</div>
          </div>
        </div>

        <div class="buttons">
          <button class="btn-sub" id="ignoreButton">ä»Šæ—¥ã¯ä½•ã‚‚ã—ãªã„</button>
          <button class="btn-sub" id="nextDayButton" style="margin-left:auto; display:none;">ã‚‚ã†ä¸€åº¦ã‚ãã¶</button>
        </div>
        <div class="message" id="messageArea"></div>
        <div class="rain-progress" id="rainProgress"></div>
      </section>

      <section class="status-card">
        <h2>ã‚¿ã‚³ã®ã‚ˆã†ã™</h2>

        <div class="status-row">
          <span class="status-label">å…ƒæ°—</span>
          <div class="bar">
            <div class="bar-fill" id="healthBar"></div>
          </div>
        </div>
        <div class="status-row">
          <span class="status-label">ãªã¤ã</span>
          <div class="bar">
            <div class="bar-fill affection" id="affectionBar"></div>
          </div>
        </div>
        <div class="status-text" id="statusText"></div>

        <div class="log" id="logArea"></div>

        <div class="result-area" id="resultArea" style="display:none;">
          <div class="result-title" id="resultTitle"></div>
          <div id="resultText"></div>

          <div class="reflection">
            <p>éŠã‚“ã§ã¿ã¦ã©ã†æ„Ÿã˜ã¾ã—ãŸã‹ï¼Ÿ</p>
            <ul>
              <li>ã‚‚ã—ã“ã‚ŒãŒäººé–“ã ã£ãŸã‚‰ã€ã©ã‚“ãªæ°—æŒã¡ã«ãªã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ</li>
              <li>AIã‚­ãƒ£ãƒ©ç›¸æ‰‹ã®ã¨ãã€ãã®æ°—æŒã¡ã¯ã©ã“ã¾ã§ä¼¼ã¦ã„ã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ</li>
              <li>ã€Œç¾©å‹™ã€ã¨ã€Œæ„›ç€ã€ã®ã‚ã„ã ã«ã€ã©ã‚“ãªã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¦‹ãˆã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ</li>
            </ul>
          </div>
        </div>
      </section>
    </div>

    <div class="tagline">
      â€» ã“ã®ã‚²ãƒ¼ãƒ ã¯ã€ãªãœäººã¯ã€Œå°ã•ãªä»–è€…ã€ã‚’ãŠä¸–è©±ã—ãŸããªã‚‹ã®ã‹ã‚’è€ƒãˆã‚‹ãŸã‚ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã§ã™ã€‚
    </div>
  </div>

  <script>
    // ã‚·ãƒ¼ãƒ³å®šç¾©ï¼ˆ3ã¤ã®ãŠä¸–è©±ï¼‹ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ç¨®åˆ¥ï¼‰
    const phases = [
      {
        id: 'sleep',
        mode: 'blanket',
        title: 'ã‚·ãƒ¼ãƒ³1ï¼šã­ãã†ã®ã‚ã‚‹ã„ã‚¿ã‚³',
        description: 'ã‚¿ã‚³ãŒãã£ã™ã‚Šå¯ã¦ã„ã¾ã™ã€‚ã§ã‚‚ã€è¶³ãŒå¸ƒå›£ã‹ã‚‰å‡ºã¦ã—ã¾ã£ã¦ã„ã¾ã™ã€‚\nå¸ƒå›£ã‚’ã¤ã‹ã‚“ã§ä¸Šã«ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã€ãã£ã¨ã‹ã‘ã¦ã‚ã’ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\nï¼ˆä½•ã‚‚ã—ãªã„ã§è¦‹ã¦ã„ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼‰',
        ignoreLabel: 'ä»Šæ—¥ã¯ãã®ã¾ã¾ã«ã—ã¦ãŠã',
        stateIcon: 'ğŸ’¤',
        applyVisual(state) {
          blanket.classList.remove('hidden');
          blanket.style.transform = 'translateY(0px)';
          rainOverlay.classList.remove('visible');
          umbrella.classList.remove('visible', 'holding');
          hairMark.classList.remove('visible');
          hairMark.textContent = 'ğŸ’¤';
        },
        onChoice(choice, state) {
          if (choice === 'care') {
            state.health += 2;
            state.affection += 2;
            addLog('ã‚¿ã‚³ã¯ã‚ãŸãŸã‹ããªã£ã¦ã€æ°—æŒã¡ã‚ˆã•ãã†ã«å¯ã¦ã„ã¾ã™ã€‚');
            return 'ã‚¿ã‚³ã¯ãƒã‚«ãƒã‚«ã€‚è¶³ã‚‚ã¡ã‚ƒã‚“ã¨å¸ƒå›£ã«å…¥ã‚Šã¾ã—ãŸã€‚';
          } else {
            state.health -= 2;
            addLog('ã‚¿ã‚³ã®è¶³ãŒå†·ãˆã¦ãã¾ã—ãŸâ€¦ã€‚');
            return 'å†·ãŸã„å¤œé¢¨ã§ã€ã¡ã‚‡ã£ã¨å¯’ãã†ã§ã™ã€‚';
          }
        }
      },
      {
        id: 'bedhead',
        mode: 'hair',
        title: 'ã‚·ãƒ¼ãƒ³2ï¼šå…ƒæ°—ã«ã‚ãã¶ã‚¿ã‚³',
        description: 'ã‚¿ã‚³ã¯å¤–ã§å…ƒæ°—ã„ã£ã±ã„ã‚ãã‚“ã§ã„ã¾ã™ã€‚\nã§ã‚‚ã€å¤‰ãªå¯ç™–ãƒ˜ã‚¢ãƒ¼ãŒã™ã”ã„ã“ã¨ã«ãªã£ã¦ã„ã¾ã™ã€‚\né«ªã®ã‚ãŸã‚Šã‚’ä½•åº¦ã‹ãªã§ã‚‹ï¼ˆã‚¿ãƒƒãƒ—ï¼ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ï¼‰ã¨ã€å¯ç™–ãŒå°‘ã—ãšã¤æ•´ã£ã¦ã„ãã¾ã™ã€‚\nï¼ˆä»Šæ—¥ã¯å€‹æ€§ã ã¨æ€ã£ã¦æ”¾ã£ã¦ãŠãã“ã¨ã‚‚ã§ãã¾ã™ï¼‰',
        ignoreLabel: 'å¯ç™–ã¯å€‹æ€§ã ã¨æ€ã£ã¦æ”¾ã£ã¦ãŠã',
        stateIcon: 'â˜€ï¸',
        applyVisual(state) {
          blanket.classList.add('hidden');
          rainOverlay.classList.remove('visible');
          umbrella.classList.remove('visible', 'holding');
          hairMark.classList.add('visible');
          hairMark.textContent = 'ğŸ’¥';
        },
        onChoice(choice, state) {
          if (choice === 'care') {
            state.affection += 2;
            addLog('ã‚¿ã‚³ã¯å°‘ã—ç…§ã‚ŒãªãŒã‚‰ã‚‚ã€ã†ã‚Œã—ãã†ã§ã™ã€‚');
            return 'é«ªï¼ˆï¼Ÿï¼‰ãŒãµã‚“ã‚ã‚Šæ•´ã£ã¦ã€ã‚¿ã‚³ã¯è‡ªä¿¡æº€ã€…ã§ã™ã€‚';
          } else {
            state.affection -= 1;
            addLog('ã‚¿ã‚³ã¯ã€Œã“ã‚Œã‚‚è‡ªåˆ†ã‚‰ã—ã•ã‹ãªã€ã¨æ€ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚');
            return 'å¯ç™–ã®ã¾ã¾ã ã‘ã©ã€ã‚¿ã‚³ã¯æ°—ã«ã—ã¦ã„ãªã„ã¿ãŸã„ã§ã™ã€‚';
          }
        }
      },
      {
        id: 'rain',
        mode: 'umbrella',
        title: 'ã‚·ãƒ¼ãƒ³3ï¼šæ€¥ãªé›¨',
        description: 'æ€¥ã«é›¨ãŒé™ã£ã¦ãã¾ã—ãŸã€‚ã‚¿ã‚³ã¯ã¾ã å¤–ã§ã‚ãã‚“ã§ã„ã¾ã™ã€‚\nå‚˜ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆğŸŒ‚ï¼‰ã‚’æŠ¼ã—ç¶šã‘ã‚‹ã¨ã€é›¨ãŒã‚„ã‚€ã¾ã§ã•ã—ã¦ã‚ã’ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\né€”ä¸­ã§æ‰‹ã‚’é›¢ã™ã¨ã€ã‚¿ã‚³ã¯ã³ã—ã‚‡ã¬ã‚Œã«ãªã£ã¦ã—ã¾ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚\nï¼ˆã‚ãˆã¦é›¨ã«ã¾ã‹ã›ã¦ã¿ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼‰',
        ignoreLabel: 'ãã®ã¾ã¾é›¨ã«ã¾ã‹ã›ã¦ã¿ã‚‹',
        stateIcon: 'ğŸŒ§ï¸',
        applyVisual(state) {
          blanket.classList.add('hidden');
          rainOverlay.classList.add('visible');
          umbrella.classList.add('visible');
          umbrella.classList.remove('holding');
          hairMark.classList.remove('visible');
        },
        onChoice(choice, state) {
          if (choice === 'care') {
            state.health += 2;
            state.affection += 1;
            addLog('ã‚¿ã‚³ã¯é›¨å®¿ã‚Šã§ãã¦ã€ã»ã£ã¨ä¸€æ¯ã¤ã„ã¦ã„ã¾ã™ã€‚');
            return 'ã‚¿ã‚³ã¯ã¬ã‚Œãšã«ã™ã¿ã¾ã—ãŸã€‚é›¨ã®éŸ³ã‚’ä¸€ç·’ã«èã„ã¦ã„ã¾ã™ã€‚';
          } else {
            state.health -= 3;
            addLog('ã‚¿ã‚³ã¯ã³ã—ã‚‡ã¬ã‚Œã«ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸâ€¦ã€‚');
            return 'ä½“ãŒå†·ãˆã¦ã—ã¾ã„ã€ä»Šæ—¥ã¯ãã£ãŸã‚Šã§ã™ã€‚';
          }
        }
      }
    ];

    const sceneTitle = document.getElementById('sceneTitle');
    const sceneDescription = document.getElementById('sceneDescription');
    const charStateIcon = document.getElementById('charStateIcon');
    const blanket = document.getElementById('blanket');
    const rainOverlay = document.getElementById('rainOverlay');
    const umbrella = document.getElementById('umbrella');
    const hairMark = document.getElementById('hairMark');
    const charVisual = document.getElementById('charVisual');

    const ignoreButton = document.getElementById('ignoreButton');
    const nextDayButton = document.getElementById('nextDayButton');
    const messageArea = document.getElementById('messageArea');
    const rainProgress = document.getElementById('rainProgress');

    const healthBar = document.getElementById('healthBar');
    const affectionBar = document.getElementById('affectionBar');
    const statusText = document.getElementById('statusText');
    const logArea = document.getElementById('logArea');

    const resultArea = document.getElementById('resultArea');
    const resultTitle = document.getElementById('resultTitle');
    const resultText = document.getElementById('resultText');

    let currentPhaseIndex = 0;
    let state = {
      health: 5,
      affection: 5
    };
    let finished = false;
    let phaseCompleted = false;

    // å¸ƒå›£ãƒ‰ãƒ©ãƒƒã‚°ç”¨
    let isDraggingBlanket = false;
    let dragStartY = 0;
    let blanketStartY = 0;
    let blanketDeltaY = 0;

    // é«ªãªã§ãªã§ç”¨
    let hairStrokeCount = 0;
    const HAIR_STROKE_TARGET = 5;

    // å‚˜ãƒ›ãƒ¼ãƒ«ãƒ‰ç”¨
    let umbrellaHolding = false;
    let umbrellaProgressValue = 0;
    let umbrellaInterval = null;
    let umbrellaTimer = null;
    const UMBRELLA_TARGET = 22; // ç´„3ç§’å¼·ãã‚‰ã„

    function addLog(text) {
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      const time = document.createElement('span');
      time.className = 'time';
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, '0');
      const mm = String(now.getMinutes()).padStart(2, '0');
      time.textContent = `[${hh}:${mm}]`;
      const content = document.createElement('span');
      content.textContent = text;
      entry.appendChild(time);
      entry.appendChild(content);
      logArea.prepend(entry);
    }

    function clamp(value, min, max) {
      return Math.max(min, Math.min(max, value));
    }

    function updateBars() {
      const h = clamp(state.health, 0, 10);
      const a = clamp(state.affection, 0, 10);
      healthBar.style.width = (h * 10) + '%';
      affectionBar.style.width = (a * 10) + '%';

      let text = '';

      if (h <= 2) {
        text += 'ä½“èª¿ï¼šã‹ãªã‚Šãã£ãŸã‚Šã—ã¦ã„ã¾ã™ã€‚';
      } else if (h <= 4) {
        text += 'ä½“èª¿ï¼šå°‘ã—ç–²ã‚Œæ°—å‘³ã§ã™ã€‚';
      } else if (h <= 7) {
        text += 'ä½“èª¿ï¼šãã“ãã“å…ƒæ°—ã§ã™ã€‚';
      } else {
        text += 'ä½“èª¿ï¼šã¨ã¦ã‚‚å…ƒæ°—ã§ã™ã€‚';
      }

      text += ' ';

      if (a <= 2) {
        text += 'ãªã¤ãï¼šã¾ã ã‚ˆãã‚ˆãã—ã„æ„Ÿã˜ã§ã™ã€‚';
      } else if (a <= 4) {
        text += 'ãªã¤ãï¼šå°‘ã—è·é›¢ãŒè¿‘ã¥ã„ã¦ãã¾ã—ãŸã€‚';
      } else if (a <= 7) {
        text += 'ãªã¤ãï¼šã‘ã£ã“ã†å¿ƒã‚’ã‚†ã‚‹ã—ã¦ãã‚Œã¦ã„ã¾ã™ã€‚';
      } else {
        text += 'ãªã¤ãï¼šã¨ã¦ã‚‚ä¿¡é ¼ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚';
      }

      statusText.textContent = text;
    }

    function setIgnoreEnabled(enabled) {
      ignoreButton.disabled = !enabled;
    }

    function clearUmbrellaTimers() {
      if (umbrellaInterval) {
        clearInterval(umbrellaInterval);
        umbrellaInterval = null;
      }
      if (umbrellaTimer) {
        clearTimeout(umbrellaTimer);
        umbrellaTimer = null;
      }
      umbrellaHolding = false;
      umbrellaProgressValue = 0;
      rainProgress.textContent = '';
      umbrella.classList.remove('holding');
    }

    function showPhase() {
      const phase = phases[currentPhaseIndex];
      phaseCompleted = false;
      sceneTitle.textContent = phase.title;
      sceneDescription.textContent = phase.description;
      charStateIcon.textContent = phase.stateIcon;
      ignoreButton.textContent = phase.ignoreLabel;
      resultArea.style.display = 'none';
      nextDayButton.style.display = 'none';
      rainProgress.textContent = '';

      // è¦–è¦šãƒªã‚»ãƒƒãƒˆ
      phase.applyVisual(state);

      // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã®ãƒªã‚»ãƒƒãƒˆ
      if (phase.mode === 'blanket') {
        messageArea.textContent = 'å¸ƒå›£ã‚’ã¤ã‹ã‚“ã§ã€ä¸Šã«ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã¿ã¦ãã ã•ã„ã€‚';
      } else if (phase.mode === 'hair') {
        hairStrokeCount = 0;
        hairMark.textContent = 'ğŸ’¥';
        messageArea.textContent = 'å¯ç™–ãƒ˜ã‚¢ãƒ¼ã®ã‚ãŸã‚Šã‚’ã€ä½•åº¦ã‹ãªã§ã¦ã¿ã¦ãã ã•ã„ã€‚';
      } else if (phase.mode === 'umbrella') {
        clearUmbrellaTimers();
        startRainPhase();
        messageArea.textContent = 'å‚˜ï¼ˆğŸŒ‚ï¼‰ã‚’æŠ¼ã—ç¶šã‘ã‚‹ã¨ã€ã‚¿ã‚³ã«é›¨ãŒã‚ãŸã‚‰ãªã„ã‚ˆã†ã«ã§ãã¾ã™ã€‚';
      }

      setIgnoreEnabled(true);
    }

    function evaluateResult() {
      finished = true;
      const h = clamp(state.health, 0, 10);
      const a = clamp(state.affection, 0, 10);

      let title;
      let text;

      if (h <= 1) {
        title = 'ä»Šæ—¥ã¯é¢¨é‚ªã‚’ã²ã„ã¦ã—ã¾ã„ã¾ã—ãŸâ€¦';
        text = 'ãŠä¸–è©±ã‚’ã‚ã¾ã‚Šã•ã‚Œãªã‹ã£ãŸã‚¿ã‚³ã¯ã€ä½“ãŒå†·ãˆãã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚\n'
             + 'ã€Œæ­»ãªã›ãªã„ã‚ˆã†ã«è‚²ã¦ã‚‹ã€ã¨ã¯ã©ã†ã„ã†ã“ã¨ã‹ã€å°‘ã—ã ã‘è€ƒãˆã¦ã¿ã¦ã‚‚ã‚ˆã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚';
      } else if (a <= 2) {
        title = 'ãªã‚“ã¨ã‹ä¸€æ—¥ã‚’çµ‚ãˆã¾ã—ãŸ';
        text = 'ã‚¿ã‚³ã¯ã‹ã‚ã†ã˜ã¦å…ƒæ°—ã§ã™ãŒã€ã¾ã ã‚ã¾ã‚Šå¿ƒã¯é€šã„åˆã£ã¦ã„ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚\n'
             + 'ã‚ãªãŸã¯ã€Œç¾©å‹™ã€ã¨ã—ã¦ã‚¿ã‚³ã‚’ãŠä¸–è©±ã—ã¦ã„ãŸã®ã§ã—ã‚‡ã†ã‹ã€‚ãã‚Œã¨ã‚‚ã€å°‘ã—ã¯æ„›ç€ãŒèŠ½ç”ŸãˆãŸã§ã—ã‚‡ã†ã‹ã€‚';
      } else {
        title = 'ã‚¿ã‚³ã¯ä»Šæ—¥ã‚‚å…ƒæ°—ã«ä¸€æ—¥ã‚’çµ‚ãˆã¾ã—ãŸ';
        text = 'ã‚¿ã‚³ã¯å…ƒæ°—ã§ã€ã‚ãªãŸã®ãã°ã«ã„ã‚‹ã“ã¨ã«å®‰å¿ƒã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚\n'
             + 'è¦‹è¿”ã‚ŠãŒãªãã¦ã‚‚ã€ãªãœã‹ã€Œã¡ã‚‡ã£ã¨ä¸–è©±ã‚’ã—ãŸããªã‚‹ã€ãã®æ°—æŒã¡ã®æ­£ä½“ã¯ä½•ã§ã—ã‚‡ã†ã‹ã€‚';
      }

      resultTitle.textContent = title;
      resultText.textContent = text;
      resultArea.style.display = 'block';
      nextDayButton.style.display = 'inline-block';
      setIgnoreEnabled(false);
      clearUmbrellaTimers();
      addLog('1æ—¥ã®ã‚·ãƒ¼ãƒ³ãŒã™ã¹ã¦çµ‚ã‚ã‚Šã¾ã—ãŸã€‚');
    }

    function goNextPhase() {
      currentPhaseIndex++;
      if (currentPhaseIndex >= phases.length) {
        evaluateResult();
      } else {
        showPhase();
      }
    }

    function handleChoice(kind) {
      if (finished || phaseCompleted) return;
      const phase = phases[currentPhaseIndex];
      phaseCompleted = true;
      setIgnoreEnabled(false);
      clearUmbrellaTimers();

      const comment = phase.onChoice(kind, state);
      updateBars();
      messageArea.textContent = comment;

      setTimeout(() => {
        goNextPhase();
      }, 900);
    }

    function resetGame() {
      state = { health: 5, affection: 5 };
      currentPhaseIndex = 0;
      finished = false;
      phaseCompleted = false;
      updateBars();
      clearUmbrellaTimers();
      showPhase();
      messageArea.textContent = 'ã‚¿ã‚³ã¨ã®ä¸€æ—¥ãŒå§‹ã¾ã‚Šã¾ã™ã€‚ã‚ãªãŸã¯ã©ã‚“ãªãŠä¸–è©±ã‚’ã—ã¾ã™ã‹ï¼Ÿ';
    }

    // ã€Œä»Šæ—¥ã¯ä½•ã‚‚ã—ãªã„ã€ãƒœã‚¿ãƒ³ â†’ ignore
    ignoreButton.addEventListener('click', () => {
      if (finished || phaseCompleted) return;
      handleChoice('ignore');
    });

    nextDayButton.addEventListener('click', () => resetGame());

    // å¸ƒå›£ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆã‚·ãƒ¼ãƒ³1ç”¨ï¼‰
    function getPointerY(e) {
      if (e.touches && e.touches.length > 0) {
        return e.touches[0].clientY;
      }
      return e.clientY;
    }

    function onBlanketDown(e) {
      const phase = phases[currentPhaseIndex];
      if (finished || phaseCompleted || phase.mode !== 'blanket' || blanket.classList.contains('hidden')) return;
      isDraggingBlanket = true;
      dragStartY = getPointerY(e);
      blanketStartY = blanketDeltaY;
      blanket.classList.add('dragging');
      e.preventDefault();
    }

    function onBlanketMove(e) {
      if (!isDraggingBlanket) return;
      const currentY = getPointerY(e);
      const dy = currentY - dragStartY;
      // ä¸Šã«ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ã¨ãƒã‚¤ãƒŠã‚¹ã€‚ã‚ã‚‹ç¨‹åº¦ã¾ã§ã«åˆ¶é™
      blanketDeltaY = clamp(blanketStartY + dy, -80, 20);
      blanket.style.transform = `translateY(${blanketDeltaY}px)`;
    }

    function onBlanketUp() {
      if (!isDraggingBlanket) return;
      isDraggingBlanket = false;
      blanket.classList.remove('dragging');

      const phase = phases[currentPhaseIndex];
      if (phase.mode !== 'blanket') return;

      // ã‚ã‚‹ç¨‹åº¦ä¸Šã¾ã§å‹•ã‹ã—ãŸã‚‰ã€Œã‹ã‘ã¦ã‚ã’ãŸã€ã¨åˆ¤å®š
      if (blanketDeltaY <= -30 && !phaseCompleted) {
        blanket.style.transform = `translateY(-40px)`;
        handleChoice('care');
      } else {
        // å…ƒã®ä½ç½®ã«æˆ»ã™
        blanketDeltaY = 0;
        blanket.style.transform = 'translateY(0px)';
      }
    }

    blanket.addEventListener('mousedown', onBlanketDown);
    blanket.addEventListener('touchstart', onBlanketDown, { passive: false });

    window.addEventListener('mousemove', onBlanketMove);
    window.addEventListener('touchmove', onBlanketMove, { passive: false });

    window.addEventListener('mouseup', onBlanketUp);
    window.addEventListener('touchend', onBlanketUp);

    // é«ªãªã§ãªã§ï¼ˆã‚·ãƒ¼ãƒ³2ç”¨ï¼‰
    hairMark.addEventListener('click', () => {
      const phase = phases[currentPhaseIndex];
      if (finished || phaseCompleted || phase.mode !== 'hair') return;

      hairStrokeCount++;
      const remaining = Math.max(HAIR_STROKE_TARGET - hairStrokeCount, 0);

      if (hairStrokeCount >= HAIR_STROKE_TARGET && !phaseCompleted) {
        hairMark.textContent = 'âœ¨';
        hairMark.style.transform = 'translate(-50%, -4px)';
        messageArea.textContent = 'ä½•åº¦ã‚‚ãªã§ã¦ã‚ã’ãŸã®ã§ã€å¯ç™–ãŒã™ã£ãã‚Šã—ã¾ã—ãŸã€‚';
        handleChoice('care');
      } else {
        messageArea.textContent = `ã‚¿ã‚³ã®å¯ç™–ã‚’ãªã§ã¦ã„ã¾ã™â€¦ï¼ˆã‚ã¨${remaining}å›ãã‚‰ã„ï¼‰`;
      }
    });

    // å‚˜ãƒ›ãƒ¼ãƒ«ãƒ‰ï¼ˆã‚·ãƒ¼ãƒ³3ç”¨ï¼‰
    function startRainPhase() {
      umbrellaProgressValue = 0;
      umbrellaHolding = false;
      phaseCompleted = false;
      rainProgress.textContent = 'é›¨ï¼šâ– â– â– â– â– â– â– â– â– â– â– â– ï¼ˆå‚˜ã‚’æŠ¼ã—ç¶šã‘ã¦ã¿ã¾ã—ã‚‡ã†ï¼‰';

      // ä¸€å®šæ™‚é–“å¾Œã«åˆ¤å®šï¼ˆã‚±ã‚¢ãŒé–“ã«åˆã‚ãªã‘ã‚Œã° ignoreï¼‰
      umbrellaTimer = setTimeout(() => {
        if (!phaseCompleted && !finished) {
          handleChoice('ignore');
        }
      }, 6000); // å…¨ä½“ã®é›¨æ™‚é–“
    }

    function updateRainProgressText() {
      const rate = clamp(umbrellaProgressValue / UMBRELLA_TARGET, 0, 1);
      const totalBlocks = 10;
      const filled = Math.round(rate * totalBlocks);
      const bar = 'â– '.repeat(filled) + 'â–¡'.repeat(totalBlocks - filled);
      rainProgress.textContent = `é›¨ï¼š${bar}ï¼ˆå‚˜ã‚’æŠ¼ã—ã¦ã„ã‚‹æ™‚é–“ï¼‰`;
    }

    function onUmbrellaDown(e) {
      const phase = phases[currentPhaseIndex];
      if (finished || phaseCompleted || phase.mode !== 'umbrella') return;
      umbrellaHolding = true;
      umbrella.classList.add('holding');
      e.preventDefault();

      if (!umbrellaInterval) {
        umbrellaInterval = setInterval(() => {
          if (!umbrellaHolding) return;
          umbrellaProgressValue++;
          updateRainProgressText();
          if (umbrellaProgressValue >= UMBRELLA_TARGET && !phaseCompleted) {
            handleChoice('care');
          }
        }, 150);
      }
    }

    function onUmbrellaUp() {
      if (!umbrellaHolding) return;
      umbrellaHolding = false;
      umbrella.classList.remove('holding');
    }

    umbrella.addEventListener('mousedown', onUmbrellaDown);
    umbrella.addEventListener('touchstart', onUmbrellaDown, { passive: false });

    window.addEventListener('mouseup', onUmbrellaUp);
    window.addEventListener('touchend', onUmbrellaUp);

    // åˆæœŸåŒ–
    updateBars();
    showPhase();
    messageArea.textContent = 'ã‚¿ã‚³ã¨ã®ä¸€æ—¥ãŒå§‹ã¾ã‚Šã¾ã™ã€‚ã¾ãšã¯å¸ƒå›£ã®æ§˜å­ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚';
    addLog('ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚');
  </script>
</body>
</html>
